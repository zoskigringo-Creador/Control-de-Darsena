<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Control Dársena</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Librería PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Librería Escáner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        /* --- ESTILO LIMPIO --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: pan-x pan-y;
        }
        
        /* Bloqueo estricto de zoom */
        button, input, select, textarea { touch-action: manipulation; }

        /* Animaciones */
        .btn-active:active { transform: scale(0.96); opacity: 0.9; transition: 0.1s; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card-clean {
            background: white;
            border-radius: 18px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* Inputs */
        .input-clean {
            background: #F5F5F7;
            border: 1px solid transparent;
            border-radius: 12px;
            transition: all 0.2s;
        }
        .input-clean:focus {
            background: #FFFFFF;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 3px var(--theme-light);
            outline: none;
        }

        /* Scroll oculto */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Variables */
        :root { --theme-color: #007AFF; --theme-light: #E5F0FF; }
        
        /* Scanner Video */
        #reader video { border-radius: 16px; object-fit: cover; }
        
        /* Pantallas */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { theme: 'var(--theme-color)', 'theme-light': 'var(--theme-light)', } } } }
    </script>
</head>
<body class="h-screen w-full overflow-hidden fixed inset-0">

    <!-- LOGIN SCREEN -->
    <div id="screen-login" class="screen active bg-white z-50 items-center justify-center p-8">
        <div class="w-full max-w-xs flex flex-col items-center fade-in">
            <div class="w-20 h-20 rounded-2xl bg-theme flex items-center justify-center shadow-xl shadow-theme/20 mb-6">
                <i data-lucide="package-check" class="text-white w-10 h-10"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 mb-1">Control Dársena</h1>
            <p class="text-gray-400 text-sm mb-8">Identificación de Auditor</p>
            
            <!-- Estado BD Login -->
            <div id="dbStatus" class="flex items-center gap-2 text-xs font-medium text-gray-400 bg-gray-50 px-3 py-1.5 rounded-full border border-gray-100 mb-6">
                <div class="w-2 h-2 bg-gray-300 rounded-full animate-pulse" id="dbLoader"></div>
                <span id="dbStatusText">Iniciando...</span>
            </div>

            <div class="w-full space-y-3">
                <input type="number" id="login-code" placeholder="Ingresa tu código (1-6)" class="w-full bg-gray-50 border border-gray-100 p-4 rounded-xl text-center text-xl font-bold outline-none focus:ring-2 focus:ring-theme transition-all" inputmode="numeric">
                <button onclick="doLogin()" id="btnLogin" class="w-full bg-theme text-white font-bold py-4 rounded-xl shadow-lg shadow-theme/20 btn-active disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Entrar
                </button>
            </div>
            
            <div class="mt-8 grid grid-cols-3 gap-2 text-[10px] text-gray-400 text-center w-full">
                <span>1. Fabio</span><span>2. Javier</span><span>3. Victor</span>
                <span>4. Brian</span><span>5. Rodrigo</span><span>6. Marcelo</span>
            </div>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="screen-app" class="screen bg-[#F5F5F7]">
        
        <!-- Header Minimalista -->
        <div class="bg-white pt-safe-top pb-3 px-5 shadow-sm z-20 sticky top-0 flex justify-between items-end">
            <div>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Auditor Activo</p>
                <h2 id="user-name-display" class="text-xl font-bold text-gray-900 leading-none">Usuario</h2>
            </div>
            <div class="w-9 h-9 rounded-full bg-gray-100 text-theme flex items-center justify-center font-bold text-sm" id="user-avatar">U</div>
        </div>

        <div id="main-content" class="flex-1 overflow-y-auto relative no-scrollbar p-4 space-y-5">
            
            <!-- VISTA: REGISTRO (HOME) -->
            <div id="view-home" class="space-y-5 pb-24 fade-in">
                
                <!-- Tarjeta de Cabecera (Limpia y Organizada) -->
                <div class="card-clean p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-theme rounded-full"></div>
                        <h3 class="font-bold text-gray-800 text-sm">DATOS DE OPERACIÓN</h3>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Dársena -->
                        <div class="relative">
                            <label class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold text-gray-400 uppercase">Dársena</label>
                            <input type="text" id="op-darsena" class="w-full input-clean p-3 text-center font-bold text-gray-800" placeholder="--" onchange="saveOpData()">
                        </div>
                        <!-- Camión -->
                        <div class="relative">
                            <label class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold text-gray-400 uppercase">Camión</label>
                            <input type="text" id="op-camion" class="w-full input-clean p-3 text-center font-bold text-gray-800" placeholder="----" onchange="saveOpData()">
                        </div>
                    </div>
                    
                    <!-- Indicador Fijo de Tipo -->
                    <div class="mt-4 flex items-center justify-center gap-2 bg-gray-50 py-2 rounded-lg border border-gray-100">
                        <i data-lucide="clipboard-list" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-xs font-bold text-gray-500">Modo: Sobrante de Mercadería</span>
                    </div>
                </div>

                <!-- Buscador y Escáner -->
                <div class="flex gap-3">
                    <div class="relative flex-1 shadow-sm">
                        <div class="absolute left-3 top-3.5 text-gray-400"><i data-lucide="search" class="w-5 h-5"></i></div>
                        <input type="text" id="search-input" onkeyup="handleSearch(event)" placeholder="Buscar producto..." 
                            class="w-full bg-white pl-10 pr-10 py-3.5 rounded-xl text-gray-800 font-medium outline-none focus:ring-2 focus:ring-theme transition-all shadow-sm" autocomplete="off">
                        <button onclick="limpiarBuscador()" id="clear-search" class="absolute right-3 top-3.5 text-gray-400 hidden"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    </div>
                    <button onclick="startScanner()" class="bg-gray-900 text-white w-14 rounded-xl flex items-center justify-center shadow-lg btn-active">
                        <i data-lucide="scan-line" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Estado BD Vacía -->
                <div id="db-empty-state" class="hidden flex flex-col items-center justify-center py-10 opacity-60">
                    <i data-lucide="database" class="w-10 h-10 text-gray-300 mb-2"></i>
                    <p class="text-sm text-gray-400">Cargando base de datos...</p>
                </div>

                <!-- Lista Resultados -->
                <div id="product-list" class="space-y-3"></div>
            </div>

            <!-- VISTA: OPCIONES -->
            <div id="view-settings" class="hidden space-y-6 pb-24 fade-in">
                <h2 class="text-xl font-bold text-gray-800 px-1">Configuración</h2>
                
                <!-- Cloud Sync -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-400 uppercase ml-2">Nube</p>
                    <div class="card-clean overflow-hidden divide-y divide-gray-50">
                        <button onclick="enviarTodoNube()" class="w-full p-4 flex justify-between items-center btn-active bg-blue-50/50">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white shadow-sm"><i data-lucide="send" class="w-4 h-4"></i></div>
                                <div class="text-left">
                                    <span class="font-bold text-gray-800 block text-sm">Enviar Pendientes</span>
                                    <span class="text-[10px] text-blue-600">Sube a Google Sheets y limpia</span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="text-blue-300 w-4 h-4"></i>
                        </button>
                        
                        <button onclick="abrirGestionCloud()" class="w-full p-4 flex justify-between items-center btn-active">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-indigo-500 flex items-center justify-center text-white shadow-sm"><i data-lucide="link" class="w-4 h-4"></i></div>
                                <div class="text-left">
                                    <span class="font-medium text-gray-700 block text-sm">Script de Carga</span>
                                    <span class="text-[10px] text-green-500 font-bold" id="cloud-status">Conectado Automático</span>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Gestión Local -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-400 uppercase ml-2">Local</p>
                    <div class="card-clean overflow-hidden divide-y divide-gray-50">
                        <button onclick="verReporte()" class="w-full p-4 flex justify-between items-center btn-active">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-emerald-500 flex items-center justify-center text-white shadow-sm"><i data-lucide="clipboard-list" class="w-4 h-4"></i></div>
                                <span class="font-medium text-gray-700 text-sm">Ver Registros Locales</span>
                            </div>
                            <span class="bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded-md" id="badge-count-settings">0</span>
                        </button>
                        
                        <button onclick="descargarExcel()" class="w-full p-4 flex justify-between items-center btn-active">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-green-600 flex items-center justify-center text-white shadow-sm"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></div>
                                <span class="font-medium text-gray-700 text-sm">Descargar Excel (Respaldo)</span>
                            </div>
                        </button>

                        <button onclick="abrirGestionDB()" class="w-full p-4 flex justify-between items-center btn-active">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-gray-500 flex items-center justify-center text-white shadow-sm"><i data-lucide="database" class="w-4 h-4"></i></div>
                                <div class="text-left">
                                    <span class="font-medium text-gray-700 block text-sm">Base de Datos Productos</span>
                                    <span class="text-[10px] text-gray-400" id="db-count-label">0 items</span>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <button onclick="cerrarSesion()" class="w-full p-4 bg-white text-red-500 font-bold rounded-2xl shadow-sm border border-red-50 btn-active text-sm">
                    Cerrar Sesión
                </button>
                
                <p class="text-center text-gray-300 text-[10px]">v8.1 • Modo Dársena</p>
            </div>
        </div>

        <!-- MENU INFERIOR FLOTANTE -->
        <div class="fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-lg rounded-2xl shadow-2xl shadow-black/10 border border-white/50 h-16 flex items-center justify-around z-30 max-w-md mx-auto">
            <button onclick="switchTab('home')" id="tab-home" class="flex flex-col items-center justify-center w-14 h-14 text-theme transition-colors">
                <i data-lucide="scan-barcode" class="w-6 h-6 mb-0.5"></i>
                <span class="text-[10px] font-bold">Registro</span>
            </button>
            <div class="w-px h-8 bg-gray-200"></div>
            <button onclick="switchTab('settings')" id="tab-settings" class="flex flex-col items-center justify-center w-14 h-14 text-gray-400 transition-colors relative">
                <i data-lucide="settings-2" class="w-6 h-6 mb-0.5"></i>
                <span class="text-[10px] font-bold">Ajustes</span>
                <div id="badge-nav" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border border-white hidden"></div>
            </button>
        </div>

        <!-- ==================== MODALES ==================== -->

        <!-- MODAL CANTIDAD -->
        <div id="modal-registro" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="cerrarModalRegistro()"></div>
            <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 shadow-2xl modal-enter max-w-md left-0 right-0 mx-auto">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span class="text-[10px] font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded mb-2 inline-block" id="modal-code">CODE</span>
                        <h3 class="text-lg font-bold text-gray-900 leading-tight w-64" id="modal-desc">Producto</h3>
                        <p class="text-xs text-gray-500 mt-1" id="modal-prov">Proveedor</p>
                    </div>
                    <button onclick="cerrarModalRegistro()" class="bg-gray-50 p-2 rounded-full text-gray-400 hover:bg-gray-100"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>

                <!-- Tipo de Registro FIJO -->
                <div class="bg-theme-light/30 border border-theme-light rounded-xl p-3 mb-6 flex items-center gap-3">
                    <div class="bg-white p-2 rounded-lg shadow-sm text-theme"><i data-lucide="clipboard" class="w-5 h-5"></i></div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Tipo de Registro</p>
                        <p class="text-sm font-bold text-theme">Sobrante de Mercadería</p>
                    </div>
                </div>

                <div class="flex items-center justify-between gap-4 mb-6">
                    <button onclick="updateQty(-1)" class="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center text-2xl text-gray-500 font-bold btn-active hover:bg-gray-200 transition-colors">-</button>
                    <input type="number" id="input-qty" class="flex-1 bg-white border-2 border-gray-100 rounded-2xl h-16 text-center text-3xl font-black text-gray-800 outline-none focus:border-theme transition-colors" placeholder="0" inputmode="numeric">
                    <button onclick="updateQty(1)" class="w-16 h-16 bg-theme rounded-2xl flex items-center justify-center text-2xl text-white font-bold btn-active shadow-lg shadow-theme/30 transition-colors">+</button>
                </div>

                <button onclick="guardar()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl text-lg shadow-xl btn-active flex justify-center items-center gap-2">
                    Confirmar Registro
                </button>
            </div>
        </div>

        <!-- MODAL ESCÁNER -->
        <div id="modal-scanner" class="fixed inset-0 z-50 hidden bg-black flex flex-col">
            <div class="flex justify-between items-center p-4 bg-black text-white z-10">
                <h3 class="font-bold text-lg">Escanear Código</h3>
                <button onclick="stopScanner()" class="bg-white/20 p-2 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="reader" class="flex-1 w-full bg-black relative overflow-hidden">
                <!-- Linea roja animada -->
                <div class="absolute top-1/2 left-10 right-10 h-0.5 bg-red-500 z-10 shadow-[0_0_10px_red] opacity-80"></div>
            </div>
            <div class="p-8 bg-black text-center">
                <p class="text-gray-400 text-sm">Apunta la cámara al código de barras</p>
            </div>
        </div>

        <!-- MODAL REPORTES (LISTA) -->
        <div id="modal-reportes" class="fixed inset-0 z-50 hidden bg-[#F5F5F7]">
            <div class="bg-white pt-safe-top pb-3 px-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
                <button onclick="cerrarReportes()" class="flex items-center text-gray-500 font-medium gap-1 p-2 -ml-2"><i data-lucide="chevron-left"></i> Volver</button>
                <h2 class="font-bold text-gray-800">Registros del Día</h2>
                <div class="w-16"></div>
            </div>
            <div id="lista-registros-container" class="p-4 space-y-3 overflow-y-auto h-[calc(100%-80px)] pb-24"></div>
        </div>

        <!-- MODAL DB -->
        <div id="modal-db" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="if(event.target===this) cerrarModalDB()">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">Base de Datos</h3>
                <div class="space-y-4">
                    <input type="text" id="db-url-input" placeholder="Enlace Google Sheets CSV" class="w-full input-clean p-3 text-sm">
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="borrarBaseDatos()" class="text-red-500 text-sm font-bold px-3">Borrar</button>
                        <button onclick="guardarConfigDB()" class="bg-theme text-white px-4 py-2 rounded-lg text-sm font-bold">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL CLOUD -->
        <div id="modal-cloud" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onclick="if(event.target===this) cerrarModalCloud()">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">Script de Carga</h3>
                <div class="space-y-4">
                    <input type="text" id="cloud-url-input" placeholder="URL Web App Script" class="w-full input-clean p-3 text-sm">
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="guardarConfigCloud()" class="bg-theme text-white px-4 py-2 rounded-lg text-sm font-bold">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURACIÓN AUTOMÁTICA ACTUALIZADA ---
        const DEFAULT_EXCEL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7gUS0hLg-DTKmCeLTT9rniA7SLjJAf7kT6Jf76ICN89Skpq5By1V4GQ15YtBugUWE5M1xYJyvZd82/pub?output=csv";
        // TU NUEVO SCRIPT DE GOOGLE APPS SCRIPT
        const DEFAULT_CLOUD_URL = "https://script.google.com/macros/s/AKfycbyRgvVkA2GEEJi3iMXtIF7gEWOSDofajRInTzRWvA9597qH3EdRWGRjwAXcXve761PE/exec";

        const USERS = { 1: "Fabio Vera", 2: "Javier Insfran", 3: "Victor Varga", 4: "Brian Quintana", 5: "Rodrigo Cabrera", 6: "Marcelo Diaz" };
        let currentUser = null, productsDB = [], registers = [], selectedProd = null;
        let opDarsena = "", opCamion = "";
        const OP_TYPE = "Sobrante de mercaderia"; // TIPO ÚNICO Y FIJO
        let html5QrcodeScanner = null;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); loadState(); loadOpData();
            const savedUser = localStorage.getItem('darsena_user');
            if(savedUser) loginUser(JSON.parse(savedUser));
        });

        function saveOpData() { opDarsena = document.getElementById('op-darsena').value; opCamion = document.getElementById('op-camion').value; localStorage.setItem('darsena_op_darsena', opDarsena); localStorage.setItem('darsena_op_camion', opCamion); }
        function loadOpData() { opDarsena = localStorage.getItem('darsena_op_darsena') || ""; opCamion = localStorage.getItem('darsena_op_camion') || ""; document.getElementById('op-darsena').value = opDarsena; document.getElementById('op-camion').value = opCamion; }

        // --- ESCÁNER V8.0 ---
        function startScanner() {
            document.getElementById('modal-scanner').classList.remove('hidden');
            const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config,
                (decodedText) => { stopScanner(); handleScannedCode(decodedText); },
                (errorMessage) => { /* ignore */ }
            ).catch(err => {
                console.error(err);
                alert("Error: Da permisos a la cámara o usa HTTPS.");
                document.getElementById('modal-scanner').classList.add('hidden');
            });
        }

        function stopScanner() {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    document.getElementById('modal-scanner').classList.add('hidden');
                }).catch(err => {
                    console.error(err);
                    document.getElementById('modal-scanner').classList.add('hidden');
                });
            } else { document.getElementById('modal-scanner').classList.add('hidden'); }
        }

        function handleScannedCode(code) {
            const match = productsDB.find(p => p.b == code || p.c == code);
            if(match) { openRegisterModal(match); }
            else { Swal.fire({ icon: 'error', title: 'No encontrado', text: `Código: ${code} no existe`, confirmButtonColor: 'var(--theme-color)' }); }
        }

        // --- BUSCADOR ---
        function handleSearch(e) {
            const query = e.target.value.trim();
            const clearBtn = document.getElementById('clear-search');
            if(query.length > 0) clearBtn.classList.remove('hidden'); else clearBtn.classList.add('hidden');
            const exactMatch = productsDB.find(p => p.c === query || p.b === query);
            if (exactMatch && e.key === 'Enter') { openRegisterModal(exactMatch); document.getElementById('search-input').blur(); return; }
            renderProductList(query);
        }
        function limpiarBuscador() { document.getElementById('search-input').value = ""; document.getElementById('clear-search').classList.add('hidden'); renderProductList(""); document.getElementById('search-input').focus(); }

        // --- LOGIN ---
        function doLogin() { const c = parseInt(document.getElementById('login-code').value); if(USERS[c]) loginUser({id:c, name:USERS[c]}); else Swal.fire({icon:'error',title:'Código incorrecto',showConfirmButton:false,timer:1000}); }
        function loginUser(u) { currentUser=u; localStorage.setItem('darsena_user',JSON.stringify(u)); document.getElementById('user-name-display').innerText=u.name.split(' ')[0]; document.getElementById('user-avatar').innerText=u.name.charAt(0); document.getElementById('screen-login').classList.remove('active'); setTimeout(()=>{document.getElementById('screen-app').classList.remove('hidden');document.getElementById('screen-app').classList.add('active')},300); renderProductList(); }
        function cerrarSesion() { localStorage.removeItem('darsena_user'); window.location.reload(); }
        function switchTab(t) { ['home','settings'].forEach(v=>{ const el=document.getElementById(`view-${v}`),b=document.getElementById(`tab-${v}`); if(v===t){el.classList.remove('hidden');b.classList.replace('text-gray-400','text-theme')}else{el.classList.add('hidden');b.classList.replace('text-theme','text-gray-400')} }); }
        function irAConfiguracion() { switchTab('settings'); setTimeout(()=>abrirGestionDB(),500); }

        // --- DATOS ---
        function loadState() {
            const r=localStorage.getItem('darsena_registros'); if(r) registers=JSON.parse(r); updateBadge();
            let u = localStorage.getItem('darsena_db_url'); if(!u && DEFAULT_EXCEL_URL) { u = DEFAULT_EXCEL_URL; localStorage.setItem('darsena_db_url', u); }
            const d=localStorage.getItem('darsena_db');
            if(u) { fetchGoogleSheet(u); } else if(d) { productsDB=JSON.parse(d); renderProductList(); statusReady(); } else { renderProductList(); statusOffline("Sin conexión"); }
            let cUrl = localStorage.getItem('darsena_cloud_url'); if (!cUrl && DEFAULT_CLOUD_URL) { cUrl = DEFAULT_CLOUD_URL; localStorage.setItem('darsena_cloud_url', cUrl); }
            if(cUrl) document.getElementById('cloud-status').innerText = "Conectado Automático";
        }
        function statusLoading(m) { document.getElementById('dbStatus').classList.remove('hidden'); document.getElementById('dbLoader').style.display='block'; document.getElementById('dbStatusText').innerText=m; document.getElementById('btnLogin').disabled=true; }
        function statusReady() { document.getElementById('dbLoader').style.display='none'; document.getElementById('dbStatusText').innerText="Base de Datos Lista"; document.getElementById('dbStatus').classList.replace('text-gray-400','text-green-600'); document.getElementById('btnLogin').disabled=false; }
        function statusOffline(m) { document.getElementById('dbLoader').style.display='none'; document.getElementById('dbStatusText').innerText=m; document.getElementById('dbStatus').classList.replace('text-gray-400','text-red-500'); document.getElementById('btnLogin').disabled=false; }

        function fetchGoogleSheet(url) {
            statusLoading("Actualizando...");
            Papa.parse(url, { download:true, header:true, skipEmptyLines:true,
                complete: function(res) {
                    if(res.data && res.data.length>0) {
                        productsDB = res.data.map(row => {
                            const k = Object.keys(row).reduce((acc, key) => { acc[key.toUpperCase().trim()] = row[key]; return acc; }, {});
                            return { c: k['COD_MERCA']||k['CODIGO']||'', b: k['COD_BARRA']||k['BARRA']||'', d: k['XDESC']||k['DESCRIPCION']||'', p: k['XDESC_DIVI']||k['PROVEEDOR']||'VARIOS', v: 0 };
                        }).filter(p => p.c !== '');
                        localStorage.setItem('darsena_db', JSON.stringify(productsDB));
                        renderProductList(); statusReady();
                        if(currentUser) Swal.fire({toast:true, position:'top-end', icon:'success', title:'BD Actualizada', showConfirmButton:false, timer:2000});
                    } else statusOffline("Hoja vacía");
                },
                error: function(e) { console.error(e); statusOffline("Error red"); }
            });
        }

        function renderProductList(filter = "") {
            const c = document.getElementById('product-list'), e = document.getElementById('db-empty-state');
            c.innerHTML = ""; if(productsDB) document.getElementById('db-count-label').innerText = `${productsDB.length} items`;
            if(!productsDB || productsDB.length===0) { e.classList.remove('hidden'); return; } else e.classList.add('hidden');
            let cnt=0; const max=50, q=filter.toLowerCase();
            const res = productsDB.filter(p => { if(cnt>=max && q==="") return false; const m = p.d.toLowerCase().includes(q) || p.c.toLowerCase().includes(q) || p.b.includes(q); if(m) cnt++; return m; });
            if(res.length===0) { c.innerHTML = `<div class="text-center py-10 text-gray-400 text-sm">No se encontró</div>`; return; }
            res.forEach(p => {
                const el = document.createElement('div');
                el.className = "card-clean p-4 flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer animate-[fadeIn_0.2s_ease-out]";
                el.onclick = () => openRegisterModal(p);
                el.innerHTML = `<div class="flex-1 pr-2"><div class="flex gap-2 mb-1.5"><span class="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-0.5 rounded">${p.c}</span><span class="text-[10px] font-bold text-theme bg-theme-light px-2 py-0.5 rounded">${p.p}</span></div><h4 class="font-bold text-sm text-gray-800 leading-snug">${p.d}</h4>${p.b?`<p class="text-[10px] text-gray-400 mt-1 font-mono tracking-wide">${p.b}</p>`:''}</div><div class="ml-2"><div class="w-10 h-10 rounded-full bg-gray-900 text-white shadow-md flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></div></div>`;
                c.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- MODALES ---
        function openRegisterModal(p) {
            selectedProd = p;
            document.getElementById('modal-code').innerText = p.c; document.getElementById('modal-desc').innerText = p.d; document.getElementById('modal-prov').innerText = p.p;
            // FIX: Eliminada línea que causaba el error null
            document.getElementById('input-qty').value = "";
            document.getElementById('modal-registro').classList.remove('hidden');
            setTimeout(() => document.getElementById('input-qty').focus(), 100);
        }
        function cerrarModalRegistro() { document.getElementById('modal-registro').classList.add('hidden'); selectedProd = null; }
        
        function updateQty(d) { 
            const i=document.getElementById('input-qty'); 
            let v=parseInt(i.value)||0; 
            v = v + d; 
            i.value = v; 
        }
        
        function guardar() {
            const q = parseInt(document.getElementById('input-qty').value);
            if(isNaN(q)) { const i=document.getElementById('input-qty'); i.parentElement.classList.add('ring-2','ring-red-500'); setTimeout(()=>i.parentElement.classList.remove('ring-2','ring-red-500'),500); return; }
            
            registers.unshift({ id:Date.now(), fecha:new Date().toLocaleDateString(), hora:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), auditor:currentUser.name, code:selectedProd.c, desc:selectedProd.d, prov:selectedProd.p, qty:q, obs:OP_TYPE, darsena:opDarsena, camion:opCamion });
            localStorage.setItem('darsena_registros', JSON.stringify(registers));
            cerrarModalRegistro(); updateBadge(); Swal.fire({icon:'success',title:'Guardado',showConfirmButton:false,timer:800,position:'center'});
        }

        // --- REPORTE Y CLOUD ---
        function verReporte() {
            document.getElementById('modal-reportes').classList.remove('hidden');
            const l = document.getElementById('lista-registros-container'); l.innerHTML = "";
            if(registers.length===0) { l.innerHTML="<p class='text-center text-gray-400 mt-10'>Lista vacía</p>"; return; }
            registers.forEach(r => {
                const i = document.createElement('div');
                i.className = "card-clean p-4 relative mb-3 border-l-4 border-theme";
                // FIX: Botón Basura con espacio seguro (margin-right)
                i.innerHTML = `
                    <div class="flex justify-between items-start" style="padding-right: 3.5rem;">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold text-gray-400"><i data-lucide="clock" class="inline w-3 h-3"></i> ${r.hora}</span>
                                <span class="text-[10px] font-bold text-theme bg-theme-light px-1.5 rounded">D:${r.darsena} C:${r.camion}</span>
                            </div>
                            <h4 class="font-bold text-gray-800 text-sm">${r.desc}</h4>
                            <p class="text-xs text-gray-400 font-mono">${r.code}</p>
                        </div>
                        <div class="text-right self-center">
                            <span class="block text-2xl font-black text-theme whitespace-nowrap">${r.qty>0?'+':''}${r.qty}</span>
                        </div>
                    </div>
                    <button onclick="borrarRegistro(${r.id})" class="absolute top-1/2 -translate-y-1/2 right-3 w-10 h-10 bg-red-50 rounded-full flex items-center justify-center text-red-500 hover:bg-red-100 transition-colors">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                l.appendChild(i);
            });
            lucide.createIcons();
        }

        function borrarRegistro(id) {
            Swal.fire({title:'¿Borrar?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',cancelButtonColor:'#3085d6'}).then((r)=>{
                if(r.isConfirmed){registers=registers.filter(r=>r.id!==id);localStorage.setItem('darsena_registros',JSON.stringify(registers));verReporte();updateBadge();}
            }) 
        }

        async function enviarTodoNube() {
            const url = localStorage.getItem('darsena_cloud_url');
            if(!url) return Swal.fire('Error', 'Script no conectado.', 'error');
            if(registers.length === 0) return Swal.fire('Vacío', 'Nada que enviar.', 'info');

            Swal.fire({title: 'Enviando...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
            try {
                await fetch(url, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(registers) });
                Swal.fire({ icon: 'success', title: '¡Enviado!', text: 'Datos subidos y lista limpiada.' });
                registers = []; localStorage.setItem('darsena_registros', JSON.stringify([])); updateBadge();
            } catch (error) {
                console.error(error); Swal.fire('Error', 'Fallo de conexión.', 'error');
            }
        }

        function updateBadge() { 
            const c = registers.length; 
            const badgeSettings = document.getElementById('badge-count-settings');
            if(badgeSettings) badgeSettings.innerText = c; 
            const badgeNav = document.getElementById('badge-nav');
            if(badgeNav) { if(c>0) badgeNav.classList.remove('hidden'); else badgeNav.classList.add('hidden'); }
        }

        // Utils
        function cerrarReportes() { document.getElementById('modal-reportes').classList.add('hidden'); }
        function abrirGestionDB() { document.getElementById('modal-db').classList.remove('hidden'); }
        function cerrarModalDB() { document.getElementById('modal-db').classList.add('hidden'); }
        function abrirGestionCloud() { document.getElementById('modal-cloud').classList.remove('hidden'); }
        function cerrarModalCloud() { document.getElementById('modal-cloud').classList.add('hidden'); }
        function guardarConfigDB() { let u=document.getElementById('db-url-input').value.trim(); if(u){localStorage.setItem('darsena_db_url',u); fetchGoogleSheet(u);} cerrarModalDB(); }
        function borrarBaseDatos() { productsDB=[]; localStorage.removeItem('darsena_db'); localStorage.removeItem('darsena_db_url'); renderProductList(); cerrarModalDB(); }
        function guardarConfigCloud() { let u=document.getElementById('cloud-url-input').value.trim(); if(u){localStorage.setItem('darsena_cloud_url',u); document.getElementById('cloud-status').innerText="Conectado Manual";} cerrarModalCloud(); }
        function descargarExcel() {
            if(registers.length===0) return Swal.fire('Vacío','Sin datos','info');
            let csv="\uFEFFFECHA;HORA;AUDITOR;DARSENA;CAMION;CODIGO;DESCRIPCION;PROVEEDOR;CANTIDAD;OBSERVACION\n";
            registers.forEach(r=>{csv+=`${r.fecha};${r.hora};${r.auditor};${r.darsena};${r.camion};${r.code};${r.desc};${r.prov};${r.qty};${r.obs}\n`});
            const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`DARSENA_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`; link.click();
        }
    </script>
</body>
</html>
